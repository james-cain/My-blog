<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WebAPI | Jamescain Blog</title>
    <meta name="description" content="A knowledge blog">
    <link rel="icon" href="/knowledge-note/favicon.ico">
    
    <link rel="preload" href="/knowledge-note/assets/css/0.styles.2a62c23f.css" as="style"><link rel="preload" href="/knowledge-note/assets/js/app.5911ee68.js" as="script"><link rel="preload" href="/knowledge-note/assets/js/33.d0be234c.js" as="script"><link rel="prefetch" href="/knowledge-note/assets/js/10.c06c8013.js"><link rel="prefetch" href="/knowledge-note/assets/js/11.e009d5ba.js"><link rel="prefetch" href="/knowledge-note/assets/js/12.7bd7ec08.js"><link rel="prefetch" href="/knowledge-note/assets/js/13.f7dd9fff.js"><link rel="prefetch" href="/knowledge-note/assets/js/14.2a1937c1.js"><link rel="prefetch" href="/knowledge-note/assets/js/15.dd234ab4.js"><link rel="prefetch" href="/knowledge-note/assets/js/16.aa68018a.js"><link rel="prefetch" href="/knowledge-note/assets/js/17.450ded1b.js"><link rel="prefetch" href="/knowledge-note/assets/js/18.e5ab91c5.js"><link rel="prefetch" href="/knowledge-note/assets/js/19.828f0cfd.js"><link rel="prefetch" href="/knowledge-note/assets/js/2.5416267e.js"><link rel="prefetch" href="/knowledge-note/assets/js/20.1f74175f.js"><link rel="prefetch" href="/knowledge-note/assets/js/21.ecc13655.js"><link rel="prefetch" href="/knowledge-note/assets/js/22.25b8b23e.js"><link rel="prefetch" href="/knowledge-note/assets/js/23.da0530a5.js"><link rel="prefetch" href="/knowledge-note/assets/js/24.adf76fe9.js"><link rel="prefetch" href="/knowledge-note/assets/js/25.c0a039ad.js"><link rel="prefetch" href="/knowledge-note/assets/js/26.41bf7655.js"><link rel="prefetch" href="/knowledge-note/assets/js/27.8cb8f7aa.js"><link rel="prefetch" href="/knowledge-note/assets/js/28.3ece7860.js"><link rel="prefetch" href="/knowledge-note/assets/js/29.5b309485.js"><link rel="prefetch" href="/knowledge-note/assets/js/3.eba998b9.js"><link rel="prefetch" href="/knowledge-note/assets/js/30.9d5ec625.js"><link rel="prefetch" href="/knowledge-note/assets/js/31.8e9db55d.js"><link rel="prefetch" href="/knowledge-note/assets/js/32.130120c0.js"><link rel="prefetch" href="/knowledge-note/assets/js/34.8e7b7627.js"><link rel="prefetch" href="/knowledge-note/assets/js/35.7fb44f32.js"><link rel="prefetch" href="/knowledge-note/assets/js/36.03fd684d.js"><link rel="prefetch" href="/knowledge-note/assets/js/37.0bb053eb.js"><link rel="prefetch" href="/knowledge-note/assets/js/38.3ed9aa63.js"><link rel="prefetch" href="/knowledge-note/assets/js/39.503b146a.js"><link rel="prefetch" href="/knowledge-note/assets/js/4.f9b24404.js"><link rel="prefetch" href="/knowledge-note/assets/js/40.79121f99.js"><link rel="prefetch" href="/knowledge-note/assets/js/41.443d405d.js"><link rel="prefetch" href="/knowledge-note/assets/js/42.14497441.js"><link rel="prefetch" href="/knowledge-note/assets/js/5.7fd892d4.js"><link rel="prefetch" href="/knowledge-note/assets/js/6.c5949721.js"><link rel="prefetch" href="/knowledge-note/assets/js/7.bd690ea3.js"><link rel="prefetch" href="/knowledge-note/assets/js/8.0d238870.js"><link rel="prefetch" href="/knowledge-note/assets/js/9.0baaa73c.js">
    <link rel="stylesheet" href="/knowledge-note/assets/css/0.styles.2a62c23f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/knowledge-note/" class="home-link router-link-active"><!----> <span class="site-name">Jamescain Blog</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/knowledge-note/knowledge/" class="nav-link router-link-active">知识库</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://twitter.com/Jamescain_lll" target="_blank" rel="noopener noreferrer" class="nav-link external">
  作者twitter
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/james-cain/My-lab" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/knowledge-note/knowledge/" class="nav-link router-link-active">知识库</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://twitter.com/Jamescain_lll" target="_blank" rel="noopener noreferrer" class="nav-link external">
  作者twitter
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/james-cain/My-lab" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>基础</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/knowledge-note/knowledge/Damn-hole-of-html5.html" class="sidebar-link">html5</a></li><li><a href="/knowledge-note/knowledge/Damn-hole-of-CSS3.html" class="sidebar-link">CSS3</a></li><li><a href="/knowledge-note/knowledge/Damn-hole-of-javascript.html" class="sidebar-link">JavaScript</a></li><li><a href="/knowledge-note/knowledge/review-the-javascript.html" class="sidebar-link">ES6</a></li><li><a href="/knowledge-note/knowledge/Damn-hole-of-design-patterns.html" class="sidebar-link">Design Patterns-设计模式</a></li><li><a href="/knowledge-note/knowledge/Damn-hole-of-http.html" class="sidebar-link">http/http2/https</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>进阶</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/knowledge-note/knowledge/Damn-hole-of-webapi.html" class="active sidebar-link">WebAPI</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-note/knowledge/Damn-hole-of-webapi.html#indexeddb" class="sidebar-link">IndexedDB</a></li><li class="sidebar-sub-header"><a href="/knowledge-note/knowledge/Damn-hole-of-webapi.html#web通信" class="sidebar-link">web通信</a></li><li class="sidebar-sub-header"><a href="/knowledge-note/knowledge/Damn-hole-of-webapi.html#message事件" class="sidebar-link">Message事件</a></li><li class="sidebar-sub-header"><a href="/knowledge-note/knowledge/Damn-hole-of-webapi.html#跨文档通信" class="sidebar-link">跨文档通信</a></li><li class="sidebar-sub-header"><a href="/knowledge-note/knowledge/Damn-hole-of-webapi.html#通道通信" class="sidebar-link">通道通信</a></li><li class="sidebar-sub-header"><a href="/knowledge-note/knowledge/Damn-hole-of-webapi.html#messagechannel和messageport对象" class="sidebar-link">MessageChannel和MessagePort对象</a></li><li class="sidebar-sub-header"><a href="/knowledge-note/knowledge/Damn-hole-of-webapi.html#execcommand" class="sidebar-link">execCommand</a></li><li class="sidebar-sub-header"><a href="/knowledge-note/knowledge/Damn-hole-of-webapi.html#notification" class="sidebar-link">notification</a></li><li class="sidebar-sub-header"><a href="/knowledge-note/knowledge/Damn-hole-of-webapi.html#pushmanager" class="sidebar-link">pushManager</a></li><li class="sidebar-sub-header"><a href="/knowledge-note/knowledge/Damn-hole-of-webapi.html#serviceworker" class="sidebar-link">ServiceWorker</a></li><li class="sidebar-sub-header"><a href="/knowledge-note/knowledge/Damn-hole-of-webapi.html#webworker" class="sidebar-link">WebWorker</a></li><li class="sidebar-sub-header"><a href="/knowledge-note/knowledge/Damn-hole-of-webapi.html#mutation-observer" class="sidebar-link">Mutation Observer</a></li><li class="sidebar-sub-header"><a href="/knowledge-note/knowledge/Damn-hole-of-webapi.html#mutationrecord" class="sidebar-link">MutationRecord</a></li></ul></li><li><a href="/knowledge-note/knowledge/Damn-hole-of-Browser.html" class="sidebar-link">Browser</a></li><li><a href="/knowledge-note/knowledge/Damn-hole-of-google-devtools.html" class="sidebar-link">google devtools</a></li><li><a href="/knowledge-note/knowledge/Damn-hole-of-network.html" class="sidebar-link">网络</a></li><li><a href="/knowledge-note/knowledge/Damn-hole-of-safe-and-hacker.html" class="sidebar-link">网络安全</a></li><li><a href="/knowledge-note/knowledge/Damn-hole-of-javascript-algonithms.html" class="sidebar-link">JavaScript数据结构</a></li><li><a href="/knowledge-note/knowledge/Damn-hole-of-performance.html" class="sidebar-link">性能优化</a></li><li><a href="/knowledge-note/knowledge/parameters-of-package.html" class="sidebar-link">详解package.json</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>工具</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/knowledge-note/knowledge/Damn-hole-of-babel.html" class="sidebar-link">babel7</a></li><li><a href="/knowledge-note/knowledge/webpack-perf.html" class="sidebar-link">Webpack打包优化</a></li><li><a href="/knowledge-note/knowledge/webpack-source-learning.html" class="sidebar-link">webpack源码</a></li><li><a href="/knowledge-note/knowledge/how-to-use-npm-sonatype.html" class="sidebar-link">用sonatype3搭建npm私服</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>拓展</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/knowledge-note/knowledge/Damn-hole-of-pwa.html" class="sidebar-link">PWA</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>浏览器详解</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/knowledge-note/knowledge/Damn-hole-of-chromium.html" class="sidebar-link">Chromium</a></li><li><a href="/knowledge-note/knowledge/Damn-hole-of-V8.html" class="sidebar-link">V8</a></li><li><a href="/knowledge-note/knowledge/Damn-hole-of-blink.html" class="sidebar-link">Blink</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>其他</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/knowledge-note/knowledge/server-record.html" class="sidebar-link">部署一台属于自己的服务器</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="webapi"><a href="#webapi" aria-hidden="true" class="header-anchor">#</a> WebAPI</h1> <h2 id="indexeddb"><a href="#indexeddb" aria-hidden="true" class="header-anchor">#</a> IndexedDB</h2> <h3 id="存储加密"><a href="#存储加密" aria-hidden="true" class="header-anchor">#</a> 存储加密</h3> <p>可以使用web的<a href="http://link.zhihu.com/?target=https%3A//developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto" target="_blank" rel="noopener noreferrer">WebCrypto<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="存储上限值"><a href="#存储上限值" aria-hidden="true" class="header-anchor">#</a> 存储上限值</h3> <table><thead><tr><th>浏览器</th> <th>限制</th></tr></thead> <tbody><tr><td>Chrome</td> <td>可用空间&lt;6%</td></tr> <tr><td>Firefox</td> <td>可用空间&lt;10%</td></tr> <tr><td>Safari</td> <td>&lt;50MB</td></tr> <tr><td>IE10</td> <td>&lt;250MB</td></tr></tbody></table> <h3 id="逐出策略"><a href="#逐出策略" aria-hidden="true" class="header-anchor">#</a> 逐出策略</h3> <table><thead><tr><th>浏览器</th> <th>逐出策略</th></tr></thead> <tbody><tr><td>Chrome</td> <td>在Chrome耗尽空间后采用LRU策略</td></tr> <tr><td>Firefox</td> <td>在整个磁盘已装满时采用LRU策略</td></tr> <tr><td>Safari</td> <td>无逐出</td></tr> <tr><td>Edge</td> <td>无逐出</td></tr></tbody></table> <h3 id="检查是否支持indexeddb"><a href="#检查是否支持indexeddb" aria-hidden="true" class="header-anchor">#</a> 检查是否支持indexedDB</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">'indexedDB'</span> <span class="token keyword">in</span> window<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'This browser doesnt support IndexedDB'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="游标索引"><a href="#游标索引" aria-hidden="true" class="header-anchor">#</a> 游标索引</h3> <p>游标可以用来遍历两个类型的数据，一个是IDBObjectStore，一个是IDBIndex</p> <ul><li>IDBObjectStore：如果在该对象上使用游标，会根据primaryKey遍历整个数据，这里不会存在重复的情况，因为primaryKey是唯一的</li> <li>IDBIndex：在index上使用游标，会以当前的index来进行遍历，其中可能会存在重复的现象</li></ul> <p>在IDBObjectStore对象上有两种方法来打开游标：</p> <ul><li>openCursor：遍历的对象是具体的数据值</li> <li>openKeyCursor：遍历的对象是数据key值</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 示例，用index打开游标</span>
index<span class="token punctuation">.</span><span class="token function">openCursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> cursor <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cursor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        customers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cursor<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cursor<span class="token punctuation">.</span><span class="token function">continue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Got all customers:'</span> <span class="token operator">+</span> customers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="数据库版本更新问题"><a href="#数据库版本更新问题" aria-hidden="true" class="header-anchor">#</a> 数据库版本更新问题</h3> <blockquote><p>同一个数据库可以同时在多个客户端（页面、工作线程）中被利用，事务确保当在读写时不会冲突。如果其中一个新的客户端期望更新数据库，除非其他客户端都关闭当前版本的数据库连接，否则是不允许的。</p> <p>为了防止新的客户端中断更新，客户端可以通过 <a href="https://www.w3.org/TR/IndexedDB/#connection-version-change-event" target="_blank" rel="noopener noreferrer">监听版本事件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>做到。该事件会在别的客户端期望更新数据库时触发。</p> <p>可以做如下操作:</p></blockquote> <p>方式一：</p> <div class="language-js extra-class"><pre class="language-js"><code>db<span class="token punctuation">.</span><span class="token function-variable function">onversionchange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 保存所有数据</span>
    <span class="token function">saveUnsave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果document不在激活态，可以直接reload页面而不需要用户交互</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>document<span class="token punctuation">.</span><span class="token function">hasFocus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果document正在focus，重新刷新页面太粗暴了，可以通过向用户弹出询问的方式会合理些</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">displayMessage</span><span class="token punctuation">(</span><span class="token string">'Please reload this page for the latest version.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">saveUnsavedData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">displayMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>方式二：调用connection的close()方法。但是，这样要确保应用对这件事知情，否则接下来的操作都会是失败的</p> <div class="language-js extra-class"><pre class="language-js"><code>db<span class="token punctuation">.</span><span class="token function-variable function">onversionchange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">saveUnsavedData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        db<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">stopUsingTheDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">stopUsingTheDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><blockquote><p>如果别的客户端在versionchange事件触发后仍持有数据库的连接，blocked事件就会触发</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> request <span class="token operator">=</span> indexedDB<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'library'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> blockedTimeout<span class="token punctuation">;</span>

request<span class="token punctuation">.</span><span class="token function-variable function">onblocked</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 给别的客户端时间异步保存数据</span>
    blockedTimeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">displayMessage</span><span class="token punctuation">(</span><span class="token string">'Upgrade blocked - Please close other tabs displaying this site.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

request<span class="token punctuation">.</span><span class="token function-variable function">onupgradeneeded</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>blockedTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">hideMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">hideMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><blockquote><p>对于已经断开了数据库连接的客户端，不会看到对应message</p></blockquote> <h3 id="object-store"><a href="#object-store" aria-hidden="true" class="header-anchor">#</a> Object Store</h3> <blockquote><p>object store是对数据库的数据的主要存储机制。每个数据库都有一系列的object stores。<code>object stores都可以被修改，但是只能使用upgrade transaction，例如，通过upgradeneeded事件响应</code>。当一个新的数据库被创建时，是不包括任何object stores的</p> <p>object  store的每个数据都有一个key和value。list根据对key升序排序。相同的key不会用重复的记录</p> <p>object store都有一个key path。如果object store有一个key path，那么会使用<strong>in-line keys</strong>，否则使用<strong>out-of-line keys</strong></p> <p>object store有一个key generator</p> <p>object store可以从记录中通过以下三种途径获取key：</p> <ol><li><strong>key generator</strong></li> <li><strong>key path</strong></li> <li><strong>可以明确的指名key值</strong>，当值被存储到object store中时。</li></ol></blockquote> <h3 id="values"><a href="#values" aria-hidden="true" class="header-anchor">#</a> Values</h3> <blockquote><p>每个记录都关联一个value。用户代理必须支持任何序列化独享。包括简单类型，如String、Date对象；和Object、Array实例，File对象、Blob对象、ImageData对象等。</p></blockquote> <h3 id="keys"><a href="#keys" aria-hidden="true" class="header-anchor">#</a> Keys</h3> <blockquote><p>为了高效检索记录，每个记录时根据它的key来组织</p> <p>key的类型包括：number，date，string，binary，array；其中binary是新提出的草案，支持的浏览器包括Chrome 58，Firefox 51和Safari 10.1</p></blockquote> <h3 id="示例"><a href="#示例" aria-hidden="true" class="header-anchor">#</a> 示例</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> request <span class="token operator">=</span> indexedDB<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;library&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
request<span class="token punctuation">.</span><span class="token function-variable function">onupgradeneeded</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> db <span class="token operator">=</span> request<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
	<span class="token keyword">var</span> store <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">createObjectStore</span><span class="token punctuation">(</span><span class="token string">&quot;books&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> keyPath<span class="token punctuation">:</span> <span class="token string">'isbn.id'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>title<span class="token punctuation">:</span> <span class="token string">&quot;Quarry Memories&quot;</span><span class="token punctuation">,</span> author<span class="token punctuation">:</span> <span class="token string">&quot;Fred&quot;</span><span class="token punctuation">,</span> isbn<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">123456</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'test'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
request<span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> db <span class="token operator">=</span> request<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
	<span class="token keyword">var</span> tx <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token string">&quot;books&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;readonly&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> store <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">objectStore</span><span class="token punctuation">(</span><span class="token string">&quot;books&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> request2 <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">123456</span><span class="token punctuation">)</span>
	request2<span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>request2<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 新增一个name object store</span>
<span class="token keyword">var</span> request <span class="token operator">=</span> indexedDB<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;library&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
request<span class="token punctuation">.</span><span class="token function-variable function">onupgradeneeded</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'upgrading'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> db <span class="token operator">=</span> request<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
	<span class="token keyword">var</span> store <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">createObjectStore</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'james'</span><span class="token punctuation">,</span> <span class="token string">'reyshieh'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
request<span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> db <span class="token operator">=</span> request<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
	<span class="token keyword">var</span> tx <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;readonly&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> store <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">objectStore</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> request2 <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'reyshieh'</span><span class="token punctuation">)</span>
	request2<span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>request2<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="api"><a href="#api" aria-hidden="true" class="header-anchor">#</a> API</h3> <ol><li><p><a href="https://developer.mozilla.org/en-US/docs/IndexedDB/IDBFactory" target="_blank" rel="noopener noreferrer"><code>IDBFactory</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 提供了对数据库的访问。这是由全局对象 <code>indexedDB</code> 实现的接口，因而也是该 API 的入口</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 打开数据库连接,该方法返回IDBOpenRequest对象</span>
<span class="token comment">// version 代表打开的数据库的版本，默认为1</span>
indexedDB<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>name<span class="token punctuation">[</span><span class="token punctuation">,</span> version<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// 删除数据库，若删除成功，返回的result将设置为undefined</span>
indexedDB<span class="token punctuation">.</span><span class="token function">deleteDatabase</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
indexedDB<span class="token punctuation">.</span><span class="token function">deleteDatabase</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token comment">// 实验阶段</span>
<span class="token comment">// 比较作为键的两个值，以确定作为indexedDB操作(如存储和迭代)的相等和顺序性</span>
<span class="token comment">// -1 first&lt;second</span>
<span class="token comment">// 0 first==second</span>
<span class="token comment">// 1 first&gt;second</span>
<span class="token comment">// 如</span>
<span class="token comment">// var a = 1;</span>
<span class="token comment">// var b = 2;</span>
<span class="token comment">// var result = window.indexedDB.cmp(a, b);</span>
indexedDB<span class="token punctuation">.</span><span class="token function">cmp</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> second<span class="token punctuation">)</span>

<span class="token comment">// 示例</span>
<span class="token keyword">var</span> note <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span>indexedDB <span class="token operator">=</span> window<span class="token punctuation">.</span>indexedDB <span class="token operator">||</span> window<span class="token punctuation">.</span>mozIndexedDB <span class="token operator">||</span> window<span class="token punctuation">.</span>webkitIndexedDB <span class="token operator">||</span> windwo<span class="token punctuation">.</span>msIndexedDB<span class="token punctuation">;</span>
<span class="token comment">// 不要使用var indexedDB = ...方式，除非在function中</span>
<span class="token comment">// 以下两个对象不需要使用windwo.mozIDB*前缀</span>
window<span class="token punctuation">.</span>IDBTransaction <span class="token operator">=</span> window<span class="token punctuation">.</span>IDBTransaction <span class="token operator">||</span> window<span class="token punctuation">.</span>webkitIDBTransaction <span class="token operator">||</span> window<span class="token punctuation">.</span>msIDBTransaction<span class="token punctuation">;</span>
window<span class="token punctuation">.</span>IDBKeyRange <span class="token operator">=</span> window<span class="token punctuation">.</span>IDBKeyRange <span class="token operator">||</span> window<span class="token punctuation">.</span>webkitIDBKeyRange <span class="token operator">||</span> window<span class="token punctuation">.</span>msIDBKeyRange<span class="token punctuation">;</span>
<span class="token keyword">var</span> DBOpenRequest <span class="token operator">=</span> window<span class="token punctuation">.</span>indexedDB<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'toDoList'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
DBOpenRequest<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    note<span class="token punctuation">.</span>innerHTML <span class="token operator">+=</span> <span class="token string">'&lt;li&gt;Error loading database.&lt;/li&gt;'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
DBOpenRequest<span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    note<span class="token punctuation">.</span>innerHTML <span class="token operator">+=</span> <span class="token string">'&lt;li&gt;Database initialised.&lt;/li&gt;'</span><span class="token punctuation">;</span>
    <span class="token comment">// 将打开的结果存储在变量中，接下来要使用，返回的result是一个用来连接的IDBDatabase对象</span>
    db <span class="token operator">=</span> DBOpenRequest<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><a href="https://developer.mozilla.org/en-US/docs/IndexedDB/IDBOpenDBRequest" target="_blank" rel="noopener noreferrer"><code>IDBOpenDBRequest</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 表示一个打开数据库的请求。</p></li> <li><p><a href="https://developer.mozilla.org/en-US/docs/IndexedDB/IDBRequest" target="_blank" rel="noopener noreferrer"><code>IDBRequest</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 提供了到数据库异步请求结果和数据库的访问。这也是在调用一个异步方法时所得到的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// window.indexedDB.open()调用后会返回该对象，用来作为打开数据库的请求</span>
<span class="token comment">// IDBOpenDBRequest实际继承于IDBRequest和EventTarget</span>
<span class="token comment">// IDBRequest将带有一个被设置为pending的readyState，当请求完成或失败，将改变为done。请求成功，返回结果将通过IDBRequest.onsuccess方法回调；如果失败，将通过IDBRequest.onerror的方法回调</span>
<span class="token comment">// IDBRequest的属性包括：</span>
IDBRequest<span class="token punctuation">.</span>error <span class="token comment">// 返回DOMException</span>
IDBRequest<span class="token punctuation">.</span>result <span class="token comment">// 返回结果，实际是IDBDatabase对象</span>
IDBRequest<span class="token punctuation">.</span>source <span class="token comment">// 返回资源为对象，如IDBIndex、IDBObjectStore或IDBCursor，如果是在indexedDB.open中回调，返回null</span>
IDBRequest<span class="token punctuation">.</span>readyState <span class="token comment">// pending or done</span>
IDBRequest<span class="token punctuation">.</span>transaction <span class="token comment">// 返回IDBTransaction对象，在没有事务的情况下会为null。如indexedDB.open，将不会有事务返回；版本更新时，在upgradeneeded事件中，transaction属性将返回一个带有等于“versionchange”模式的IDBTransaction，可以在事件中做更新以及别的操作，更新完成后，transaction属性又恢复为null</span>

<span class="token comment">// IDBRequest的事件包括：</span>
IDBRequest<span class="token punctuation">.</span>onerror
IDBRequest<span class="token punctuation">.</span>onsuccess

<span class="token comment">// IDBOpenRequest的事件包括：</span>
IDBOpenRequest<span class="token punctuation">.</span>onblocked
IDBOpenRequest<span class="token punctuation">.</span>onupgradeneeded

<span class="token comment">// 示例</span>
<span class="token keyword">var</span> openRequest <span class="token operator">=</span> indexedDB<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'db'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>openRequest<span class="token punctuation">.</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回null</span>

openRequest<span class="token punctuation">.</span><span class="token function-variable function">onupgradeneeded</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>openRequest<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回versionchange</span>
    <span class="token keyword">var</span> db <span class="token operator">=</span> openRequest<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>oldVersion <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建新的数据库</span>
        db<span class="token punctuation">.</span><span class="token function">createObjectStore</span><span class="token punctuation">(</span><span class="token string">'books'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>oldVersion <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> bookStore <span class="token operator">=</span> openRequest<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span><span class="token function">objectStore</span><span class="token punctuation">(</span><span class="token string">'books'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bookStore<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token string">'by_title'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

openRequest<span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>openRequest<span class="token punctuation">.</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回null</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><a href="https://developer.mozilla.org/en-US/docs/IndexedDB/IDBDatabase" target="_blank" rel="noopener noreferrer"><code>IDBDatabase</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 表示数据库的连接。只能通过这个连接来拿到一个数据库事务。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 属性</span>
IDBDatabase<span class="token punctuation">.</span>name <span class="token comment">// 返回连接数据库的名称，即open(name)中的name</span>
IDBDatabase<span class="token punctuation">.</span>version <span class="token comment">// 返回链接数据库的版本，初次创建时，属性值为空字符串</span>
IDBDatabase<span class="token punctuation">.</span>objectStoreNames <span class="token comment">// 包含的所有object store的名称list</span>

<span class="token comment">// 事件</span>
IDBDatabase<span class="token punctuation">.</span>onabort <span class="token comment">// 数据库使用终止时回调</span>
IDBDatabase<span class="token punctuation">.</span>onclose <span class="token comment">// 数据库close，如会话关闭</span>
IDBDatabase<span class="token punctuation">.</span>onerror <span class="token comment">// 数据库使用失败</span>
IDBDatabase<span class="token punctuation">.</span>onversionchange <span class="token comment">// 数据库结构发生变化(IDBOpenDBRequest.onupgradeneeded事件或IDBFactory.deleteDatabase())，不同于IDBVersionChangeEvent，但是相关联的</span>

<span class="token comment">// 方法</span>
IDBDatabase<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
IDBDatabase<span class="token punctuation">.</span><span class="token function">createObjectStore</span><span class="token punctuation">(</span>name<span class="token punctuation">[</span><span class="token punctuation">,</span> options<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 创建或返回一个新的object store或index，即IDBObjectStore对象</span>
<span class="token comment">// options 包括keyPath、autoIncrement(true时，用key生成器自增，默认为false)</span>
IDBDatabase<span class="token punctuation">.</span><span class="token function">deleteObjectStore</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token comment">// 通过给定名字销毁object store</span>
IDBDatabase<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span>storeNames<span class="token punctuation">[</span><span class="token punctuation">,</span> mode<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 返回事务对象(IDBTransaction)包含IDBTransaction.objectStore方法 storeNames可以是字符串数组，如果只有一个，可以直接用字符串名称</span>
<span class="token comment">// 获取所有数据库可以使用db.objectStoreNames</span>
<span class="token comment">// var transaction = db.transaction(db.objectStoreNames);</span>
<span class="token comment">// mode有三个模式：readonly,readwrite,readwriteflush，默认为readonly，尽可能不要使用readwrite，除非必须写数据库</span>
</code></pre></div></li> <li><p><a href="https://developer.mozilla.org/en-US/docs/IndexedDB/IDBObjectStore" target="_blank" rel="noopener noreferrer"><code>IDBObjectStore</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 表示一个对象存储空间。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 属性</span>
IDBObjectStore<span class="token punctuation">.</span>indexNames <span class="token comment">// 返回indexes名称list</span>
IDBObjectStore<span class="token punctuation">.</span>keyPath
IDBObjectStore<span class="token punctuation">.</span>name <span class="token comment">// 获取store名称</span>
IDBObjectStore<span class="token punctuation">.</span>transaction <span class="token comment">// 获取属于哪个IDBTransaction对象</span>
IDBObjectStore<span class="token punctuation">.</span>autoIncrement <span class="token comment">// 自动增长计步，返回true/false</span>

<span class="token comment">// 方法</span>
IDBObjectStore<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token comment">// 返回IDBRequest对象，该方法只做插入，如果只更新已经存在的记录，要使用IDBObjectStore.put方法</span>
IDBObjectStore<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 返回IDBRequest对象，清除所有的数据，如果只想删除部分数据，要用IDBObjectStore.delete方法</span>
IDBObjectStore<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">[</span>query<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 返回IDBRequest对象，返回所有记录的数量或所有匹配key、IDBKeyRange的记录数量</span>
IDBObjectStore<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span>indexName<span class="token punctuation">,</span> keyPath<span class="token punctuation">[</span><span class="token punctuation">,</span> objectParameters<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 返回IDBIndex对象，创建一个新的字段/列，定义一个新的数据点</span>
<span class="token comment">// objectParameters为IDBIndexParameters对象，可以包括属性：unique、multiEntry、locale</span>
<span class="token comment">// objectStore.createIndex('hours', 'hours', { unique: true });</span>
IDBObjectStore<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key or KeyRange<span class="token punctuation">)</span> <span class="token comment">// 返回IDBRequest对象</span>
IDBObjectStore<span class="token punctuation">.</span><span class="token function">deleteIndex</span><span class="token punctuation">(</span>indexName<span class="token punctuation">)</span> <span class="token comment">// 删除index</span>
IDBObjectStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token comment">// 返回IDBRequest对象，根据key查询object store，该方法不管是否是unique，都会返回第一个与键相关联的记录</span>
IDBObjectStore<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token comment">// 返回IDBRequest对象，返回主键的值</span>
IDBObjectStore<span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span>query<span class="token punctuation">,</span> count<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 返回IDBRequest对象，该方法返回所有值</span>
IDBObjectStore<span class="token punctuation">.</span><span class="token function">getAllKeys</span><span class="token punctuation">(</span><span class="token punctuation">[</span>query<span class="token punctuation">,</span> count<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 返回IDBRequest对象</span>
IDBObjectStore<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
IDBObjectStore<span class="token punctuation">.</span><span class="token function">openCursor</span><span class="token punctuation">(</span><span class="token punctuation">[</span>query<span class="token punctuation">,</span> direction<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 返回IDBRequest对象，在单独线程中，返回一个新的IDBCursorWithValue对象</span>
<span class="token comment">// direction为IDBCursorDirection对象，合法值包括next、nextunique、prev、prevunique，默认next</span>
IDBObjectStore<span class="token punctuation">.</span><span class="token function">openKeyCursor</span><span class="token punctuation">(</span><span class="token punctuation">[</span>query<span class="token punctuation">,</span> direction<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 返回IDBRequest对象，在单独线程中，返回一个新的IDBCursor对象</span>
IDBObjectStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token punctuation">,</span> key<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// put可以指定key来影响key generator，当且仅当key是数值且高于最后生成key</span>
<span class="token comment">// 示例</span>
store <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">createObjectStore</span><span class="token punctuation">(</span><span class="token string">'store'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> autoIncrement<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// will get key 1</span>
store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// will get key 3</span>
store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// will get key 4</span>
store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// will get key -10</span>
store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'e'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// will get key 5</span>
store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'f'</span><span class="token punctuation">,</span> <span class="token number">6.00001</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// will get 6.00001</span>
store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// will get key 7</span>
store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'f'</span><span class="token punctuation">,</span> <span class="token number">8.9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// will get 8.9999</span>
store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// will get key 9</span>
store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'h'</span><span class="token punctuation">,</span> <span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// will get key 'foo'</span>
store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// will get key 10</span>
store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'j'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// will use key [1000]</span>
store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'k'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// will get key 11</span>
</code></pre></div></li> <li><p><a href="https://developer.mozilla.org/en-US/docs/IndexedDB/IDBIndex" target="_blank" rel="noopener noreferrer"><code>IDBIndex</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 提供了到索引元数据的访问。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 索引是一种对象存储，用来在另一个对象存储中查找记录</span>
<span class="token comment">// 可以通过主键或者索引搜索记录</span>
<span class="token comment">// 索引中的每个记录只能指向其引用的对象存储中的一条记录，但是多个索引可以引用相同的对象存储</span>

<span class="token comment">// 属性</span>
IDBIndex<span class="token punctuation">.</span>isAutoLocale <span class="token comment">// 返回判断索引是否有locale值的Boolean值</span>
IDBIndex<span class="token punctuation">.</span>locale <span class="token comment">// 返回locale值(如en-US)</span>
IDBIndex<span class="token punctuation">.</span>name <span class="token comment">// 索引的名称</span>
IDBIndex<span class="token punctuation">.</span>objectStore <span class="token comment">// 索引关联的对象存储名</span>
IDBIndex<span class="token punctuation">.</span>keyPath <span class="token comment">// 索引的键</span>
IDBIndex<span class="token punctuation">.</span>multiEntry <span class="token comment">// 返回boolean值，当计算索引的keyPath的结果生成数组时，影响索引的行为</span>
<span class="token comment">// true: 对于键数组中的每个项，索引中都有一条记录</span>
<span class="token comment">// false: 对于数组中的每个键，都有一个记录</span>
IDBIndex<span class="token punctuation">.</span>unique <span class="token comment">// 如果true，索引不允许键值重复</span>

<span class="token comment">// 方法</span>
IDBIndex<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 返回IDBRequest对象，返回记录数</span>
IDBIndex<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token comment">// 返回IDBRequest对象，返回与值匹配的值</span>
IDBIndex<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 该方法不管是否是unique，都会返回第一个与键相关联的记录</span>
IDBIndex<span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span>query<span class="token punctuation">,</span> count<span class="token punctuation">]</span><span class="token punctuation">)</span>
IDBIndex<span class="token punctuation">.</span><span class="token function">getAllKeys</span><span class="token punctuation">(</span><span class="token punctuation">[</span>query<span class="token punctuation">,</span> count<span class="token punctuation">]</span><span class="token punctuation">)</span>
IDBIndex<span class="token punctuation">.</span><span class="token function">openCursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
IDBIndex<span class="token punctuation">.</span><span class="token function">openKeyCursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p><a href="https://developer.mozilla.org/en-US/docs/IndexedDB/IDBCursor" target="_blank" rel="noopener noreferrer"><code>IDBCursor</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 遍历对象存储空间和索引。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 属性</span>
IDBCursor<span class="token punctuation">.</span>source
IDBCursor<span class="token punctuation">.</span>direction <span class="token comment">// 遍历方向，next、nextUnique、prev、prevUnique</span>
IDBCursor<span class="token punctuation">.</span>key
IDBCursor<span class="token punctuation">.</span>value
IDBCursor<span class="token punctuation">.</span>primaryKey

<span class="token comment">// 方法</span>
IDBCursor<span class="token punctuation">.</span><span class="token function">advance</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token comment">// 在游标方向往前走的步数</span>
IDBCursor<span class="token punctuation">.</span><span class="token function">continue</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token comment">// 将当前游标位置移动到指定key的位置，如果没有提供key则代表移动到下一位置</span>
IDBCursor<span class="token punctuation">.</span><span class="token function">continuePrimaryKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
IDBCursor<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
IDBCursor<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 示例</span>
objectStore<span class="token punctuation">.</span><span class="token function">openCursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> cursor <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cursor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// cursor.key</span>
        <span class="token comment">// cursor.value</span>
        cursor<span class="token punctuation">.</span><span class="token function">continue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Entries all displayed.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><a href="https://developer.mozilla.org/en-US/docs/IndexedDB/IDBTransaction" target="_blank" rel="noopener noreferrer"><code>IDBTransaction</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 表示一个事务。在数据库上创建一个事务，指定它的范围（例如希望访问哪一个对象存储空间），并确定希望的访问类型（只读或写入）。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 属性</span>
IDBTransaction<span class="token punctuation">.</span>db <span class="token comment">// 返回数据库连接</span>
IDBTransaction<span class="token punctuation">.</span>error 
IDBTransaction<span class="token punctuation">.</span>mode <span class="token comment">// readonly、readwrite、versionchange，默认值为readonly</span>
IDBTransaction<span class="token punctuation">.</span>objectStoreNames <span class="token comment">// 返回IDBObjectStore对象的名称list</span>

<span class="token comment">// 事件</span>
IDBTransaction<span class="token punctuation">.</span>onabort
IDBTransaction<span class="token punctuation">.</span>oncomplete
IDBTransaction<span class="token punctuation">.</span>onerror

<span class="token comment">// 方法</span>
IDBTransaction<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 事务发生异常时，回滚所有对象变化</span>
IDBTransaction<span class="token punctuation">.</span><span class="token function">objectStore</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token comment">// 返回IDBObjectStore实例</span>
</code></pre></div></li> <li><p><a href="https://developer.mozilla.org/en-US/docs/Web/API/IDBKeyRange" target="_blank" rel="noopener noreferrer"><code>IDBKeyRange</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 定义键的范围。</p> <blockquote><p>通过该属性，可以限制range使用大写、小写绑定。如，遍历所有键值，其中值的范围在A-Z。</p> <p>可以使用以下代码结构，检索所有键在一个确认的范围：</p></blockquote> <p>All keys &lt;= x: IDBKeyRange.upperBound(x)</p> <p>All keys &lt; x: IDBKeyRange.upperBound(x, true)</p> <p>All keys &gt;= y: IDBKeyRange.lowerBound(y)</p> <p>All keys &gt; y: IDBKeyRange.lowerBound(y, true)</p> <p>All keys &gt;= x &amp;&amp; &lt;= y: IDBKeyRange.bound(x, y)</p> <p>All keys &gt; x &amp;&amp; &lt; y: IDBKeyRange.bound(x, y, true, true)</p> <p>All keys &gt; x &amp;&amp; &lt;=y: IDBKeyRange.bound(x, y, true, false)</p> <p>All keys &gt;= x &amp;&amp; &lt; y: IDBKeyRange.upperBound(x, y, false, true)</p> <p>All keys = z: IDBKeyRange.only(z)</p></li> <li><p><a href="https://developer.mozilla.org/en-US/docs/IndexedDB/IDBCursorWithValue" target="_blank" rel="noopener noreferrer"><code>IDBCursorWithValue</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 遍历对象存储空间和索引并返回游标的当前值。</p></li> <li><p><a href="https://developer.mozilla.org/en-US/docs/IndexedDB/IDBEnvironment" target="_blank" rel="noopener noreferrer"><code>IDBEnvironment</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 提供了到客户端数据库的访问。它由 <a href="https://developer.mozilla.org/en-US/docs/DOM/window" target="_blank" rel="noopener noreferrer">window<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 对象实现。</p> <p>IDBEnvironment.indexedDB // 工厂函数，包含IDBFactory对象</p></li> <li><p><a href="https://developer.mozilla.org/en-US/docs/IndexedDB/IDBVersionChangeEvent" target="_blank" rel="noopener noreferrer"><code>IDBVersionChangeEvent</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 表明数据库的版本号已经改变。</p> <div class="language-js extra-class"><pre class="language-js"><code>IDBVersionChangeEvent<span class="token punctuation">.</span>oldVersion <span class="token comment">// 返回旧版本数据库的版本号</span>
IDBVersionChangeEvent<span class="token punctuation">.</span>newVersion <span class="token comment">// 返回新版本数据库的版本号</span>
</code></pre></div></li></ol> <h2 id="web通信"><a href="#web通信" aria-hidden="true" class="header-anchor">#</a> web通信</h2> <p>web通信，实际有两个略不同的系统，<strong>跨文档通信(cross-document messaging)<strong>和</strong>通道通信(channel messaging)</strong>。</p> <p>无论是跨文档通信（cross-document messaging）、通道通信（channel messaging）、服务器发送事件（server-sent events）或是网络套接字（web sockets）都要执行<strong>message事件</strong></p> <h2 id="message事件"><a href="#message事件" aria-hidden="true" class="header-anchor">#</a> Message事件</h2> <p>包含5个只读属性</p> <table><thead><tr><th>属性名</th> <th>含义</th></tr></thead> <tbody><tr><td>data</td> <td>包含任意字符串数据，由原始脚本发送</td></tr> <tr><td>origin</td> <td>一个字符串，包含原始文档的方案、域名以及端口</td></tr> <tr><td>lastEventId</td> <td>一个字符串，包含了当前的消息事件的唯一标识符</td></tr> <tr><td>source</td> <td>原始文件的窗口的引用</td></tr> <tr><td>ports</td> <td>一个数组，包含任何MessagePort对象发送消息</td></tr></tbody></table> <p>在跨文档通信和通道通信中，lastEventId的值一般为空字符串；lastEventId应用在服务器端发送事件上。</p> <p>发送消息中如果没有ports，则ports属性值就是个长度为0的数组</p> <p>MessageEvent继承DOM事件接口，且属性共享。然而，<strong>通信事件并没有冒泡，不能取消，也没有默认行为</strong></p> <h2 id="跨文档通信"><a href="#跨文档通信" aria-hidden="true" class="header-anchor">#</a> 跨文档通信</h2> <p>IE8+浏览器支持</p> <p>发送核心JS代码：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>frames<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span>
</code></pre></div><p>postMessage方法支持两个参数</p> <table><thead><tr><th>参数</th> <th>含义</th></tr></thead> <tbody><tr><td>message</td> <td>发送的数据</td></tr> <tr><td>targetOrigin</td> <td>发送数据的来源</td></tr></tbody></table> <p>postMessage中的message参数不仅仅可以是字符串，结构对象、数据对象（如：File和ArrayBuffer）或是数组</p> <p>但<strong>IE8/IE9/FireFox3.6只支持字符串数据</strong></p> <p>targetOrigin *<strong><strong>-&gt;接收任何目标来源 <strong>/</strong> -&gt; 限制信息只能同源发送。注意在指定来源的时候，后面</strong>不要带斜杆</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'发送消息'</span><span class="token punctuation">,</span> <span class="token string">'http://example.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 而不是</span>
window<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'发送消息'</span><span class="token punctuation">,</span> <span class="token string">'http://example.com/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="通道通信"><a href="#通道通信" aria-hidden="true" class="header-anchor">#</a> 通道通信</h2> <p>消息通道提供了一个直接，双向浏览上下文之间的通信手段。管道每端为端口，数据从一个端口发送，另一个变成输入</p> <h2 id="messagechannel和messageport对象"><a href="#messagechannel和messageport对象" aria-hidden="true" class="header-anchor">#</a> MessageChannel和MessagePort对象</h2> <p>创建一个MessageChannel对象，实际上创造了两个相互关联的端口。一个端口保持开放，为发送端。另外一个被转发到其他浏览上下文</p> <p>MessagePort，包含三个可用方法</p> <table><thead><tr><th>方法名</th> <th>含义</th></tr></thead> <tbody><tr><td>postMessage()</td> <td>通过通道发送消息</td></tr> <tr><td>start()</td> <td>开始在端口上分派接受的信息</td></tr> <tr><td>close()</td> <td>关闭端口</td></tr></tbody></table> <p>MessagePort对象还有onmessage事件属性，可被用来定义事件句柄而不是事件监听</p> <h3 id="实例"><a href="#实例" aria-hidden="true" class="header-anchor">#</a> 实例</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 本例组成由 主页面+内部嵌套两个iframe页面(iframe1和iframe2)</span>
<span class="token comment">// 首先是第一个iframe页面(称为iframe1)，主要完成任务为实现表单提交，通知另外一个iframe页(称为iframe2)，在iframe2中展现。在做表单提交前，需要先通知主页面已经加载好；并且接受来自主页面的传递进来的端口信息</span>
<span class="token keyword">var</span> eleForm <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;form&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> port<span class="token punctuation">;</span>
eleForm<span class="token punctuation">.</span><span class="token function-variable function">onsubmit</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> message <span class="token operator">=</span> documenet<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;input[type='test']&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>port <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span>'信息发送失败，目前没有可用的端口&quot;<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// postMessage为主页面中发送</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>evt<span class="token punctuation">.</span>origin <span class="token operator">===</span> <span class="token string">'https://coracain.com'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            port <span class="token operator">=</span> evt<span class="token punctuation">.</span>ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">alert</span><span class="token punctuation">(</span>evt<span class="token punctuation">.</span>origin <span class="token operator">+</span> <span class="token string">'来源不认识'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'iframe1页加载完毕'</span><span class="token punctuation">,</span> <span class="token string">'https://coracain.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 右边iframe2页主要接收来自iframe1发送的信息，并展示。</span>
<span class="token comment">// 主要完成任务，一是创建MessageChannel通道对象，二是告诉主页面，加载完了，并把端口传过去，三是显示发送过来的信息</span>
<span class="token keyword">var</span> eleBox <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#message'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">messageHandler</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    eleBox<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'接收到的信息是'</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>MessageChannel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建一个新的MessageChannel对象</span>
        <span class="token keyword">var</span> mc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 给父级发送一个端口</span>
        window<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'iframe2页加载完毕'</span><span class="token punctuation">,</span> <span class="token string">'https://coracain.com'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>mc<span class="token punctuation">.</span>port1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 显示发送的信息</span>
        mc<span class="token punctuation">.</span>port2<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> messageHandler<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mc<span class="token punctuation">.</span>port2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        eleBox<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'浏览器不支持通道通信'</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 主页面主要是做将iframe2中的通道端口传递到iframe1，让两个iframe打通</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>evt<span class="token punctuation">.</span>origin <span class="token operator">===</span> <span class="token string">'https://coracain.com'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>evt<span class="token punctuation">.</span>ports<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 将端口转移到iframe1文档</span>
            window<span class="token punctuation">.</span>frames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'端口打开'</span><span class="token punctuation">,</span> <span class="token string">'https://coracain.com'</span><span class="token punctuation">,</span> evt<span class="token punctuation">.</span>ports<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="execcommand"><a href="#execcommand" aria-hidden="true" class="header-anchor">#</a> execCommand</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 探测浏览器是否支持copy命令</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>document<span class="token punctuation">.</span>queryCommandSupported <span class="token operator">&amp;&amp;</span> document<span class="token punctuation">.</span><span class="token function">queryCommandSupported</span><span class="token punctuation">(</span><span class="token string">'copy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 复制指定文本信息</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">copy</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fakeElem <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'textarea'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fakeElem<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">'absolute'</span><span class="token punctuation">;</span>
  fakeElem<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token string">'-9999px'</span><span class="token punctuation">;</span>
  fakeElem<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'readonly'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fakeElem<span class="token punctuation">.</span>value <span class="token operator">=</span> text<span class="token punctuation">;</span>
  fakeElem<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span><span class="token string">'copy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    fakeElem<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>fakeElem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="notification"><a href="#notification" aria-hidden="true" class="header-anchor">#</a> notification</h2> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>notifyMe()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Notify me!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">notifyMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先检查浏览器是否支持</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">&quot;Notification&quot;</span> <span class="token keyword">in</span> window<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;This browser does not support desktop notification&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 检查用户是否同意接受通知</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Notification<span class="token punctuation">.</span>permission <span class="token operator">===</span> <span class="token string">&quot;granted&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> notification <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Notification</span><span class="token punctuation">(</span><span class="token string">&quot;Hi there!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 否则需要向用户获取权限</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Notification<span class="token punctuation">.</span>permission <span class="token operator">===</span> <span class="token string">&quot;denied&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Notification<span class="token punctuation">.</span><span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">permission</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果用户同意，就可以向他们发送通知</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>permission <span class="token operator">===</span> <span class="token string">&quot;granted&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> notification <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Notification</span><span class="token punctuation">(</span><span class="token string">&quot;Hi there!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="pushmanager"><a href="#pushmanager" aria-hidden="true" class="header-anchor">#</a> pushManager</h2> <p>浏览器实现消息推送，和native app一样，依赖于推送服务。是服务器、浏览器和推送服务三者之间进行的。首先要使用Notification.requestPermission 让用户授权，只有允许后，才会向浏览器推送服务。</p> <p>订阅服务过程，服务端需要一个唯一标识的身份区分不同的浏览器。由服务器端使用web-push生成<strong>applicationServerKey</strong>，这个key存在公钥和私钥，都需要转换成<code>UInt8Array</code>格式，公钥用于浏览器向推送服务发送请求，获取对应的PushSubscription(推送订阅对象)，再将该对象发送给服务器存储。完整的推送订阅对象结构如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token string">&quot;endpoint&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;https://fcm.googleapis.com/fcm/send/...&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;keys&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;p256dh&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;BNcRd...&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;auth&quot;</span>   <span class="token punctuation">:</span> <span class="token string">&quot;tBHI...&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中<code>endpoint</code>就是推送服务返回的唯一标识用户设备的地址，而<code>keys</code>是浏览器预先生成的，包含了用于安全验证信息</p> <h3 id="第一步，订阅消息的具体实现步骤如下："><a href="#第一步，订阅消息的具体实现步骤如下：" aria-hidden="true" class="header-anchor">#</a> 第一步，订阅消息的具体实现步骤如下：</h3> <ol><li>注册 Service Worker</li> <li>使用 pushManager 添加订阅，浏览器向推送服务发送请求，其中传递参数对象包含两个属性：
<ul><li><code>userVisibleOnly</code>，不允许静默的推送，所有推送都对用户可见，所以值为<code>true</code></li> <li><code>applicationServerKey</code>，服务器生成的公钥</li></ul></li> <li>得到推送服务成功响应后，浏览器将推送服务返回的 endpoint 加入推送订阅对象，向服务器发送这个对象供其存储</li></ol> <p>具体代码实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 将base64的applicationServerKey转换成UInt8Array</span>
<span class="token keyword">function</span> <span class="token function">urlBase64ToUint8Array</span><span class="token punctuation">(</span><span class="token parameter">base64String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> padding <span class="token operator">=</span> <span class="token string">'='</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">-</span> base64String<span class="token punctuation">.</span>length <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> base64 <span class="token operator">=</span> <span class="token punctuation">(</span>base64String <span class="token operator">+</span> padding<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\-/g</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/_/g</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> rawData <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">atob</span><span class="token punctuation">(</span>base64<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> outputArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>rawData<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> max <span class="token operator">=</span> rawData<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        outputArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> rawData<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> outputArray<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">serviceWorkerReg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    serviceWorkerReg<span class="token punctuation">.</span>pushManager<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// 2.订阅</span>
    	userVisibleOnly<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    	appliactionServerKey<span class="token punctuation">:</span> <span class="token function">urlBase64ToUint8Array</span><span class="token punctuation">(</span><span class="token string">'&lt;applicationServerKey&gt;'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">subscription</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 3.发送推送订阅对象到服务器，具体实现中发送请求到后端api</span>
        <span class="token function">sendEndPointInSubscription</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Notifacation<span class="token punctuation">.</span>permission <span class="token operator">===</span> <span class="token string">'denied'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 用户拒绝了订阅请求</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator <span class="token operator">&amp;&amp;</span> <span class="token string">'PushManager'</span> <span class="token keyword">in</span> window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 1.注册service worker</span>
    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'./service-worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>ready<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token function">subscribe</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>取消订阅：</p> <div class="language-js extra-class"><pre class="language-js"><code>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>ready<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">reg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    reg<span class="token punctuation">.</span>pushManager<span class="token punctuation">.</span><span class="token function">getSubscription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">subscription</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        subscription<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">successful</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>推送服务的响应</p> <p>接下来，服务端可以向endpoint发送包含以上请求头的请求了，推送服务响应<code>201</code>标识接受调用。其余响应状态码如下：</p> <ul><li>429 Too many requests</li> <li>400 Invalid request</li> <li>404 Not Found 订阅过期，需要在服务端删除保存的推送订阅对象</li> <li>410 Gone 订阅失效，需要在服务端删除保存的推送订阅对象，并调用推送订阅对象的<code>unsubscribe()</code>方法</li> <li>413 Payload size too large</li></ul> <h3 id="第二步，使用web-push发送消息"><a href="#第二步，使用web-push发送消息" aria-hidden="true" class="header-anchor">#</a> 第二步，使用web-push发送消息</h3> <p><a href="https://github.com/web-push-libs/web-push" target="_blank" rel="noopener noreferrer">web-push<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>可以帮助生成公私钥，用<code>setVapidDetail</code>设置公私钥，并且调用<code>sendNotification</code>可以向推送服务发起调用请求，根据返回状态码做响应操作</p> <p>具体实现可以如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> webpush <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'web-push'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> vapidKeys <span class="token operator">=</span> webpush<span class="token punctuation">.</span><span class="token function">generateVAPIDKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 1. 生成公私钥</span>
webpush<span class="token punctuation">.</span><span class="token function">setVapidDetails</span><span class="token punctuation">(</span> <span class="token comment">// 2.设置公私钥</span>
	<span class="token string">'mailto:sender@example.com'</span><span class="token punctuation">,</span>
	vapidKeys<span class="token punctuation">.</span>publicKey<span class="token punctuation">,</span>
	vapidKeys<span class="token punctuation">.</span>privateKey
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 3.从数据库中拿出之前保存的pushSubscription</span>
<span class="token comment">// 4.向推送服务发起调用请求</span>
webpush<span class="token punctuation">.</span><span class="token function">sendNotification</span><span class="token punctuation">(</span>pushSubscription<span class="token punctuation">,</span> <span class="token string">'推送消息内容'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>statusCode <span class="token operator">===</span> <span class="token number">410</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从数据库中删除推送订阅对象</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="第三步，显示通知"><a href="#第三步，显示通知" aria-hidden="true" class="header-anchor">#</a> 第三步，显示通知</h3> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'push'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> promiseChain <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> self<span class="token punctuation">.</span>registration<span class="token punctuation">.</span><span class="token function">showNotification</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>title<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>promiseChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="serviceworker"><a href="#serviceworker" aria-hidden="true" class="header-anchor">#</a> ServiceWorker</h2> <p>service worker属于 <a href="https://html.spec.whatwg.org/multipage/workers.html#workers" target="_blank" rel="noopener noreferrer">web worker<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>一类。service worker会在注册service worker client的源上执行。</p> <p>service worker包括一些state，如parsed、installing、installed、activating、activated和redundant。初始化于parsed</p> <p>service worker关联包含自己的注册表（<a href="https://w3c.github.io/ServiceWorker/#dfn-service-worker-registration" target="_blank" rel="noopener noreferrer">service worker registration<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）</p> <p>Service worker带有一个全局对象（<a href="https://w3c.github.io/ServiceWorker/#serviceworkerglobalscope" target="_blank" rel="noopener noreferrer">ServiceWorkerGlobalScope<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）</p> <h3 id="service-worker-registration"><a href="#service-worker-registration" aria-hidden="true" class="header-anchor">#</a> Service Worker Registration</h3> <p>包括scope url和一组service workers:installing worker（状态为installing 或null）、waiting worker（状态为installed或null）、active worker（状态为activating、activated或null）</p> <p>包括最新更新检测时间(last update check time)，默认为null</p> <p>通过cache mode来更新，包括imports、all或none，默认为imports</p> <p>包括uninstalling flag，默认不设置</p> <p>包括<a href="https://w3c.github.io/ServiceWorker/#navigationpreloadmanager" target="_blank" rel="noopener noreferrer">NavigationPerloadManager<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>对象</p> <p>包括navigation preload enabled标记，默认不设置</p> <p>包括navigation preload header值，默认为true</p> <h3 id="service-worker-client"><a href="#service-worker-client" aria-hidden="true" class="header-anchor">#</a> Service Worker Client</h3> <p>Service worker client是一个环境。service worker client有一个相关联的废弃标志，默认不设置。</p> <p>如果sevice worker client是环境设置对象，那么它有一个定义返回service worker client源的算法；否则将返回service worker client创建URL源的地址</p> <p>window client：全局对象是Window对象的service worker client</p> <p>dedicated worker client：全局对象是<a href="https://html.spec.whatwg.org/multipage/workers.html#dedicatedworkerglobalscope" target="_blank" rel="noopener noreferrer">DedicatedWorkerGlobalScope<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>对象的service worker client</p> <p>shared worker client：全局对象是<a href="https://html.spec.whatwg.org/multipage/workers.html#sharedworkerglobalscope" target="_blank" rel="noopener noreferrer">SharedWorkerGlobalScope<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>对象的service worker client</p> <p>worker client：dedicated worker client和shared worker client</p> <p>service worker client选择并使用service worker registration来进行对自己和子资源的加载。依靠对非子资源请求来对service worker registration选择，是匹配service worker registration从scope改变成注册映射的过程。</p> <p>当请求的url不是本地时，service worker client从scope到注册映射匹配service worker registration。也就是说，service worker client视图尝试咨询service worker registration--将scope url和创建URL相匹配。</p> <p>如果匹配成功，被选择的service worker registration的激活worker将开始控制service worker client。否则，将返回到默认行为的位置。</p> <h3 id="client-context"><a href="#client-context" aria-hidden="true" class="header-anchor">#</a> Client Context</h3> <h4 id="serviceworker-2"><a href="#serviceworker-2" aria-hidden="true" class="header-anchor">#</a> ServiceWorker</h4> <div class="language-c# extra-class"><pre class="language-text"><code>[SecureContext, Exposed=(Window,Worker)]
interface ServiceWorker : EventTarget {
  readonly attribute USVString scriptURL;
  readonly attribute ServiceWorkerState state;
  void postMessage(any message, optional sequence&lt;object&gt; transfer = []);

  // event
  attribute EventHandler onstatechange;
};
ServiceWorker includes AbstractWorker;

enum ServiceWorkerState {
  &quot;installing&quot;,
  &quot;installed&quot;,
  &quot;activating&quot;,
  &quot;activated&quot;,
  &quot;redundant&quot;
};
</code></pre></div><p>该对象会在<code>ServiceWorkerRegistration.active</code>属性和<code>ServiceWorkerContainer.controller</code>属性中可用，它是一个激活并在控制页面的serviceWorker</p> <p>包括scriptURL和state两个只读属性。scriptURL必须和注册该ServiceWorker的文档处在同一域，state值可以为installing、installed、activating、activated或redundant</p> <ul><li><p>scriptURL</p> <div class="language- extra-class"><pre class="language-text"><code>// script放在https://example.com/app.html下
navigator.serviceWorker.register('/service_worker.js');
// 注册完成后,通过navigator.serviceWorker.controller.scriptURL返回的值为&quot;https://example.com/service_worker.js&quot;
</code></pre></div></li> <li><p>state</p> <p>返回的值为ServiceWorkerState(installing,installed,activating,activated,redundant)之一</p></li> <li><p>postMessage(message, transfer)</p></li></ul> <h4 id="serviceworkerregistration"><a href="#serviceworkerregistration" aria-hidden="true" class="header-anchor">#</a> ServiceWorkerRegistration</h4> <div class="language-c# extra-class"><pre class="language-text"><code>[SecureContext, Exposed=(Window,Worker)]
interface ServiceWorkerRegistration : EventTarget {
  readonly attribute ServiceWorker? installing;
  readonly attribute ServiceWorker? waiting;
  readonly attribute ServiceWorker? active;
  [SameObject] readonly attribute NavigationPreloadManager navigationPreload;

  readonly attribute USVString scope;
  readonly attribute ServiceWorkerUpdateViaCache updateViaCache;

  [NewObject] Promise&lt;void&gt; update();
  [NewObject] Promise&lt;boolean&gt; unregister();

  // event
  attribute EventHandler onupdatefound;
};

enum ServiceWorkerUpdateViaCache {
  &quot;imports&quot;,
  &quot;all&quot;,
  &quot;none&quot;
};
</code></pre></div><ul><li><p>scope</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 以上面scriptURL为例</span>
navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>ready<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">registration</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>registration<span class="token punctuation">.</span>scope<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// https://exmaple.com/</span>
</code></pre></div></li></ul> <h4 id="navigator-serviceworker"><a href="#navigator-serviceworker" aria-hidden="true" class="header-anchor">#</a> navigator.serviceWorker</h4> <div class="language-c# extra-class"><pre class="language-text"><code>partial interface Navigator {
  [SecureContext, SameObject] readonly attribute ServiceWorkerContainer serviceWorker;
};

partial interface WorkerNavigator {
  [SecureContext, SameObject] readonly attribute ServiceWorkerContainer serviceWorker;
};
</code></pre></div><p>返回ServiceWorkerContainer对象</p> <h4 id="serviceworkercontainer"><a href="#serviceworkercontainer" aria-hidden="true" class="header-anchor">#</a> ServiceWorkerContainer</h4> <div class="language-c# extra-class"><pre class="language-text"><code>[SecureContext, Exposed=(Window,Worker)]
interface ServiceWorkerContainer : EventTarget {
  readonly attribute ServiceWorker? controller;
  readonly attribute Promise&lt;ServiceWorkerRegistration&gt; ready;

  [NewObject] Promise&lt;ServiceWorkerRegistration&gt; register(USVString scriptURL, optional RegistrationOptions options);

  [NewObject] Promise&lt;any&gt; getRegistration(optional USVString clientURL = &quot;&quot;);
  [NewObject] Promise&lt;FrozenArray&lt;ServiceWorkerRegistration&gt;&gt; getRegistrations();

  void startMessages();


  // events
  attribute EventHandler oncontrollerchange;
  attribute EventHandler onmessage; // event.source of message events is ServiceWorker object
  attribute EventHandler onmessageerror;
};
</code></pre></div><ul><li><p>ServiceWorkerContainer.controller</p> <p>当ServiceWorker的state是active时，返回一个ServiceWorker对象（和ServiceWorkerRegisteration.active）返回的对象相同。如果当前的state不是active或强制刷新浏览器则返回null</p></li> <li><p>ServiceWorkerContainer.ready</p> <p>定义serviceWorker是否准备好为一个页面服务，返回一个Promise对象。当ServiceWorkerRegistration获取到一个active的ServiceWorker时被解决</p></li> <li><p>register(scriptURL, options)</p></li> <li><p>onmessage</p></li></ul> <h4 id="navigationpreloadmanager"><a href="#navigationpreloadmanager" aria-hidden="true" class="header-anchor">#</a> NavigationPreloadManager</h4> <div class="language-c# extra-class"><pre class="language-text"><code>[SecureContext, Exposed=(Window,Worker)]
interface NavigationPreloadManager {
  Promise&lt;void&gt; enable();
  Promise&lt;void&gt; disable();
  Promise&lt;void&gt; setHeaderValue(ByteString value);
  Promise&lt;NavigationPreloadState&gt; getState();
};

dictionary NavigationPreloadState {
  boolean enabled = false;
  ByteString headerValue;
};
</code></pre></div><ul><li><p>enable()</p> <p>触发时，返回promise对象并且对注册表添加navigation preload enabled标签</p></li> <li><p>diable()</p> <p>触发时，返回promise对象并且取消navigation preload enabled标签</p></li> <li><p>setHeaderValue(value)</p> <p>设置Service-Worker-Navigation-Preload头并返回一个空Promise</p></li> <li><p>getState()</p></li></ul> <p>例子</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>registration<span class="token punctuation">.</span>navigationPreload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">await</span> self<span class="token punctuation">.</span>registration<span class="token punctuation">.</span>navigationPreload<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Preloaded Response</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从缓存中读响应</span>
        <span class="token keyword">const</span> cachedResponse <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedResponse<span class="token punctuation">)</span> <span class="token keyword">return</span> cachedResponse<span class="token punctuation">;</span>
        <span class="token comment">// else 使用preloaded响应</span>
        <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> event<span class="token punctuation">.</span>preloadedResponse<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token keyword">return</span> response<span class="token punctuation">;</span>
        <span class="token comment">// else 网络请求</span>
        <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="serviceworkerglobalscope"><a href="#serviceworkerglobalscope" aria-hidden="true" class="header-anchor">#</a> ServiceWorkerGlobalScope</h4> <p>ServiceWorker的全局执行上下文</p> <div class="language-c# extra-class"><pre class="language-text"><code>[Global=(Worker,ServiceWorker), Exposed=ServiceWorker]
interface ServiceWorkerGlobalScope : WorkerGlobalScope {
  [SameObject] readonly attribute Clients clients;
  [SameObject] readonly attribute ServiceWorkerRegistration registration;

  [NewObject] Promise&lt;void&gt; skipWaiting();

  attribute EventHandler oninstall;
  attribute EventHandler onactivate;
  attribute EventHandler onfetch;

  // event
  attribute EventHandler onmessage; // event.source of the message events is Client object
  attribute EventHandler onmessageerror;
};
</code></pre></div><ul><li><p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Clients" target="_blank" rel="noopener noreferrer">Clients<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p>skipWaiting()</p> <p>允许service worker直接从registration的waiting阶段跳到active阶段</p></li></ul> <h4 id="client"><a href="#client" aria-hidden="true" class="header-anchor">#</a> Client</h4> <div class="language-c# extra-class"><pre class="language-text"><code>[Exposed=ServiceWorker]
interface Client {
  readonly attribute USVString url;
  readonly attribute FrameType frameType;
  readonly attribute DOMString id;
  readonly attribute ClientType type;
  void postMessage(any message, optional sequence&lt;object&gt; transfer = []);
};

[Exposed=ServiceWorker]
interface WindowClient : Client {
  readonly attribute VisibilityState visibilityState;
  readonly attribute boolean focused;
  [SameObject] readonly attribute FrozenArray&lt;USVString&gt; ancestorOrigins;
  [NewObject] Promise&lt;WindowClient&gt; focus();
  [NewObject] Promise&lt;WindowClient?&gt; navigate(USVString url);
};

enum FrameType {
  &quot;auxiliary&quot;,
  &quot;top-level&quot;,
  &quot;nested&quot;,
  &quot;none&quot;
};
</code></pre></div><p>Client对象即service worker client。带有一个frame type，包括auxiliary、top-level、nested和none</p> <ul><li>postMessage(message, transfer)</li></ul> <h4 id="clients"><a href="#clients" aria-hidden="true" class="header-anchor">#</a> Clients</h4> <div class="language-c# extra-class"><pre class="language-text"><code>[Exposed=ServiceWorker]
interface Clients {
  // The objects returned will be new instances every time
  [NewObject] Promise&lt;any&gt; get(DOMString id);
  [NewObject] Promise&lt;FrozenArray&lt;Client&gt;&gt; matchAll(optional ClientQueryOptions options);
  [NewObject] Promise&lt;WindowClient?&gt; openWindow(USVString url);
  [NewObject] Promise&lt;void&gt; claim();
};
</code></pre></div><p>当用户代理创建了ServiceWorkerGlobalScope对象时，必须创建一个Clients对象</p> <ul><li><p>claim()</p> <p>允许激活的service worker设置自己</p></li></ul> <h4 id="event"><a href="#event" aria-hidden="true" class="header-anchor">#</a> Event</h4> <h5 id="extendableevent"><a href="#extendableevent" aria-hidden="true" class="header-anchor">#</a> ExtendableEvent</h5> <div class="language-c# extra-class"><pre class="language-text"><code>[Constructor(DOMString type, optional ExtendableEventInit eventInitDict), Exposed=ServiceWorker]
interface ExtendableEvent : Event {
  void waitUntil(Promise&lt;any&gt; f);
};
</code></pre></div><p>event.waitUntil(f)</p> <h5 id="fetchevent"><a href="#fetchevent" aria-hidden="true" class="header-anchor">#</a> FetchEvent</h5> <div class="language-c# extra-class"><pre class="language-text"><code>[Constructor(DOMString type, FetchEventInit eventInitDict), Exposed=ServiceWorker]
interface FetchEvent : ExtendableEvent {
  [SameObject] readonly attribute Request request;
  readonly attribute Promise&lt;any&gt; preloadResponse;
  readonly attribute DOMString clientId;
  readonly attribute DOMString resultingClientId;
  readonly attribute DOMString replacesClientId;

  void respondWith(Promise&lt;Response&gt; r);
};
</code></pre></div><h5 id="events"><a href="#events" aria-hidden="true" class="header-anchor">#</a> Events</h5> <p><strong>install</strong>: Service Worker安装成功后被触发的事件，在事件处理函数中可以添加需要缓存的文件</p> <p><strong>activate</strong>: 当Service Worker安装完成后并进入激活状态，会触发activate事件。通过监听activate事件可以做一些预处理，如对旧版本的更新、对无用缓存的清理等</p> <p><strong>message</strong>: Service Worker运行于独立context中，无法直接访问当前页面主线程的DOM等信息，但是通过postMessage API，可以实现消息的传递，这样主线程就可以接受Service Worker的指令操作DOM</p> <p><strong>fetch</strong>(请求): 当浏览器在当前指定的scope下发起请求时，会触发fetch事件，并得到传有response参数的回调函数，回调中就可以做各种代理缓存的事情</p> <p><strong>push</strong>(推送): push事件是为推送准备的。依赖于Notification API和PUSH API。通过PUSH API，当订阅了推送服务后，可以使用推送方式唤醒Service Worker以响应来自系统消息传递服务的消息，即使<strong>用户已经关闭了页面</strong></p> <p><strong>sync</strong>(后台同步): sync事件由background sync（后台）同步发出。background sync配合Service Worker推出的API，用于为Service Worker提供一个可以实现注册和监听同步处理的方法。但<strong>还不在W3C Web API标准中</strong></p> <p><strong>notificationclick</strong></p> <p><strong>notificationclose</strong></p> <p><strong>canmakepayment</strong></p> <p><strong>paymentrequest</strong></p> <p><strong>messageerror</strong></p> <h3 id="caches"><a href="#caches" aria-hidden="true" class="header-anchor">#</a> Caches</h3> <div class="language-c# extra-class"><pre class="language-text"><code>[SecureContext, Exposed=(Window,Worker)]
interface Cache {
  [NewObject] Promise&lt;any&gt; match(RequestInfo request, optional CacheQueryOptions options);
  [NewObject] Promise&lt;FrozenArray&lt;Response&gt;&gt; matchAll(optional RequestInfo request, optional CacheQueryOptions options);
  [NewObject] Promise&lt;void&gt; add(RequestInfo request);
  [NewObject] Promise&lt;void&gt; addAll(sequence&lt;RequestInfo&gt; requests);
  [NewObject] Promise&lt;void&gt; put(RequestInfo request, Response response);
  [NewObject] Promise&lt;boolean&gt; delete(RequestInfo request, optional CacheQueryOptions options);
  [NewObject] Promise&lt;FrozenArray&lt;Request&gt;&gt; keys(optional RequestInfo request, optional CacheQueryOptions options);
};
</code></pre></div><h3 id="security-considerations"><a href="#security-considerations" aria-hidden="true" class="header-anchor">#</a> Security Considerations</h3> <h4 id="secure-context"><a href="#secure-context" aria-hidden="true" class="header-anchor">#</a> Secure Context</h4> <p>Service workers必须执行在secure contexts中。因此service workers和他的service worker clients需要在HTTPS域中。同样也允许在localhost，127.0.0.0/8，::1/128供开发使用。</p> <h4 id="importscripts-urls"><a href="#importscripts-urls" aria-hidden="true" class="header-anchor">#</a> importScripts(urls)</h4> <p>当被ServiceWorkerGlobalScope对象调用执行该方法时，必将import 脚本到worker global scope中，给到ServiceWorkerGlobalScope对象和urls，并对每个请求执行fetch操作</p> <h3 id="service-worker与页面通信"><a href="#service-worker与页面通信" aria-hidden="true" class="header-anchor">#</a> Service Worker与页面通信</h3> <p>Service Worker没有直接操作页面DOM的权限，但是可以通过postMessage方法和Web页面进行通信，让页面操作DOM</p> <ol><li><p><strong>Client</strong>:postMessage(message, transfer)</p> <p>在<code>sw.js</code>中向页面发信息，可以采用client.postMessage()方法</p> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">clients</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>clients <span class="token operator">&amp;&amp;</span> clients<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 发送字符串'sw.update'</span>
            client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'sw.update'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p><strong>ServiceWorkerContainer</strong>: onmessage()</p> <p>在页面中接收<code>sw.js</code>发来的信息，通过event.data来读取数据</p> <div class="language-js extra-class"><pre class="language-js"><code>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>data <span class="token operator">===</span> <span class="token string">'sw.update'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 此处可以操作页面的DOM元素</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p><strong>ServiceWorker</strong>:postMessage(message, transfer)</p> <p>在主页面给ServiceWorker发消息，可以采用navigation.serviceWorker.controller.postMessage()方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 点击指定DOM时给Service Worker发送消息</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'app-refresh'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller <span class="token operator">&amp;&amp;</span> navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'sw.updatedone'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p><strong>ServiceWorkerGlobalScope</strong>: onmessage()</p> <p>在<code>sw.js</code>中接收主页面发来的信息，通过event.data来读取数据</p> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出：'sw.updatedone'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ol> <p>同样可以使用MessageChannel创建一个信道，并在这个信道的两个MessagePort属性来传递数据。</p> <p>以https://googlechrome.github.io/samples/service-worker/post-message/为例</p> <p>截取service-worker.js 通讯相关部分：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// This is a somewhat contrived example of using client.postMessage() to originate a message from</span>
<span class="token comment">// the service worker to each client (i.e. controlled page).</span>
<span class="token comment">// Here, we send a message when the service worker starts up, prior to when it's ready to start</span>
<span class="token comment">// handling events.</span>
self<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">clients</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'The service worker just started up.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Handling message event:'</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">...</span>
      <span class="token comment">// This command adds a new request/response pair to the cache.</span>
      <span class="token keyword">case</span> <span class="token string">'add'</span><span class="token punctuation">:</span>
        <span class="token comment">// If event.data.url isn't a valid URL, new Request() will throw a TypeError which will be handled</span>
        <span class="token comment">// by the outer .catch().</span>
        <span class="token comment">// Hardcode {mode: 'no-cors} since the default for new Requests constructed from strings is to require</span>
        <span class="token comment">// CORS, and we don't have any way of knowing whether an arbitrary URL that a user entered supports CORS.</span>
        <span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>mode<span class="token punctuation">:</span> <span class="token string">'no-cors'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>url<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          event<span class="token punctuation">.</span>ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            error<span class="token punctuation">:</span> <span class="token keyword">null</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If the promise rejects, handle it by returning a standardized error message to the controlled page.</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Message handling failed:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>

    event<span class="token punctuation">.</span>ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      error<span class="token punctuation">:</span> error<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Beginning in Chrome 51, event is an ExtendableMessageEvent, which supports</span>
  <span class="token comment">// the waitUntil() method for extending the lifetime of the event handler</span>
  <span class="token comment">// until the promise is resolved.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'waitUntil'</span> <span class="token keyword">in</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Without support for waitUntil(), there's a chance that if the promise chain</span>
  <span class="token comment">// takes &quot;too long&quot; to execute, the service worker might be automatically</span>
  <span class="token comment">// stopped before it's complete.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">showCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#add'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      command<span class="token punctuation">:</span> <span class="token string">'add'</span><span class="token punctuation">,</span>
      url<span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#url'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If the promise resolves, just display a success message.</span>
      ChromeSamples<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">'Added to cache.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>ChromeSamples<span class="token punctuation">.</span>setStatus<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// If the promise rejects, show the error.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// This wraps the message posting/response in a promise, which will resolve if the response doesn't</span>
  <span class="token comment">// contain an error, and reject with the error if it does. If you'd prefer, it's possible to call</span>
  <span class="token comment">// controller.postMessage() and set up the onmessage handler independently of a promise, but this is</span>
  <span class="token comment">// a convenient wrapper.</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> messageChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    messageChannel<span class="token punctuation">.</span>port1<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// This sends the message data as well as transferring messageChannel.port2 to the service worker.</span>
    <span class="token comment">// The service worker can then use the transferred port to reply via postMessage(), which</span>
    <span class="token comment">// will in turn trigger the onmessage handler on messageChannel.port1.</span>
    <span class="token comment">// See https://html.spec.whatwg.org/multipage/workers.html#dom-worker-postmessage</span>
    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span>
      <span class="token punctuation">[</span>messageChannel<span class="token punctuation">.</span>port2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Set up a listener for messages posted from the service worker.</span>
  <span class="token comment">// The service worker is set to post a message to all its clients once it's run its activation</span>
  <span class="token comment">// handler and taken control of the page, so you should see this message event fire once.</span>
  <span class="token comment">// You can force it to fire again by visiting this page in an Incognito window.</span>
  navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ChromeSamples<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'service-worker.js'</span><span class="token punctuation">)</span>
    <span class="token comment">// Wait until the service worker is active.</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>ready<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// ...and then show the interface for the commands once it's ready.</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>showCommands<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Something went wrong during registration. The service-worker.js file</span>
      <span class="token comment">// might be unavailable or contain a syntax error.</span>
      ChromeSamples<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  ChromeSamples<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">'This browser does not support service workers.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="webworker"><a href="#webworker" aria-hidden="true" class="header-anchor">#</a> WebWorker</h2> <blockquote><p>独立于任何UI脚本在后台运行脚本的API</p> <p>解决长时间运行的脚本问题，不会因影响用户点击或其他交互而中断</p> <p>解决耗时任务问题，不会为了保持页面可响应而立即返回</p> <p>通常workers应该有较长的生命期，较高的启动性能消耗，且每个实例都会产生较高的内存消耗</p></blockquote> <p>e.g.</p> <ol><li>数字密集型计算的后台worker</li></ol> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE HTML&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Worker example: One-core computation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>The highest prime number discovered so far is: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>output</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>result<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>output</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
   <span class="token keyword">var</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>对应的worker.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
search<span class="token punctuation">:</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    n <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span> search<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">postMessage</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>Javascript模块化worker</li></ol> <p>使用Javascript import声明来引入其他模块的能力；默认严格模式；顶层声明不会污染worker的全局作用域</p> <p>模块workers可以使用跨域脚本实例化，只要使用CORS协议把该脚本暴露出来</p> <p>模块worker中importScripts()方法将自动失效，Javascript import声明是更好的选择</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">&quot;worker.js&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">&quot;module&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  worker<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> receiveFromWorker<span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="3"><li>共享worker</li></ol> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
	<span class="token keyword">var</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">&quot;test.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> log <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;log&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	worker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span>textContent <span class="token operator">+=</span> <span class="token string">'\n'</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// test.js</span>
<span class="token function-variable function">onconnect</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> port <span class="token operator">=</span> e<span class="token punctuation">.</span>ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>也可以使用addEventListener()接收事件</p> <p>e.g.</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
	<span class="token comment">// 该例子向worker发送一个事件使得worker以另一个事件回复</span>
	<span class="token keyword">var</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">&quot;test.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> log <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;log&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	worker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span>textContent <span class="token operator">+=</span> <span class="token string">&quot;\n&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	worker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用addEventLitener事件方式必须用该方法</span>
	worker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'ping'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// test.js</span>
<span class="token function-variable function">onconnect</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> port <span class="token operator">=</span> e<span class="token punctuation">.</span>ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    port<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token comment">// 不是e.ports[0].postMessage</span>
        port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;pong&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token comment">// 或者可以使用</span>
        <span class="token comment">// e.target.postMessage(&quot;pong&quot;);</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>两个页面连接到同一个worker，第二个页面在第一个页面中的iframe</p> <p>e.g.</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE HTML&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Shared workers: demo 3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>log<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Log:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">var</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'test.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> log <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'log'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  worker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span>textContent <span class="token operator">+=</span> <span class="token string">'\n'</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  worker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  worker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'ping'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>inner.html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- inner.html --&gt;</span>
<span class="token doctype">&lt;!DOCTYPE HTML&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Shared workers: demo 3 inner frame<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span>log</span><span class="token punctuation">&gt;</span></span>Inner log:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">var</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'test.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> log <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'log'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  worker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   log<span class="token punctuation">.</span>textContent <span class="token operator">+=</span> <span class="token string">'\n'</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// test.js</span>
<span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token function-variable function">onconnect</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> port <span class="token operator">=</span> e<span class="token punctuation">.</span>ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'Hello World! You are connection #'</span> <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  port<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'pong'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>通过共享worker共享状态</li></ol> <p>同时打开多个窗口浏览同一个地图。在一个worker的协调下，所有窗口共享同样的地图信息。每个窗口都可以独立地随意移动，一旦在地图上设置了任何数据，其他窗口也都会更新</p> <ol start="5"><li>委托</li></ol> <p>可以将计算密集型任何分割到多个worker中来得到更好的性能</p> <p>e.g. 将1到10000000的所有数字进行操作的计算密集型的任务移交给10个子worker</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
	<span class="token keyword">var</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> e<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// worker.js</span>
<span class="token keyword">var</span> num_workers <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> items_per_worker <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> pending_workers <span class="token operator">=</span> num_workers<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_workers<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'core.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>i <span class="token operator">*</span> items_per_worker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> items_per_worker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    worker<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> storeResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">storeResult</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">+=</span> <span class="token number">1</span> <span class="token operator">*</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    pending_workers <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pending_workers <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">postMessage</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// core.js</span>
<span class="token keyword">var</span> start<span class="token punctuation">;</span>
onmessage <span class="token operator">=</span> getStart<span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">getStart</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    start <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">*</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    onmessage <span class="token operator">=</span> getEnd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> end<span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    end <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">*</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    onmessage <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token function">work</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">work</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">postMessage</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="api-2"><a href="#api-2" aria-hidden="true" class="header-anchor">#</a> API</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'helper.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 加入type: module代表模块脚本</span>
<span class="token keyword">var</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'helper.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'module'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用postMessage()方法来向Worker发送数据。该通信通道可以发送结构化数据，如果要发送ArrayBuffer对象(通过直接传输它们而不是克隆后发送)，在第二个参数上提供它们的列表</span>
worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    operation<span class="token punctuation">:</span> <span class="token string">'find-edges'</span><span class="token punctuation">,</span>
    input<span class="token punctuation">:</span> buffer<span class="token punctuation">,</span><span class="token comment">// ArrayBuffer对象</span>
    threshold<span class="token punctuation">:</span> <span class="token number">0.6</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>buffer<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 共享worker</span>
<span class="token comment">// 使用SharedWorker()构造函数来创建共享worker。该构造函数使用脚本URL作为第一个参数，worker名(如果有的话)作为第二个参数</span>
<span class="token keyword">var</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'service.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
worker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
worker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'some message'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 在共享worker内，新的client会使用connect事件来声明，新的client的port由事件对象的source属性给出</span>
<span class="token function-variable function">onconnect</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> newPort <span class="token operator">=</span> event<span class="token punctuation">.</span>source<span class="token punctuation">;</span>
  <span class="token comment">// set up a listener</span>
  newPort<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// send a message back to the port</span>
  newPort<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'ready!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// can also send structured data, of course</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="workerglobalscope"><a href="#workerglobalscope" aria-hidden="true" class="header-anchor">#</a> WorkerGlobalScope</h3> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">WorkerGlobalScope</span> <span class="token punctuation">:</span> EventTarget <span class="token punctuation">{</span>
  <span class="token keyword">readonly</span> attribute WorkerGlobalScope self<span class="token punctuation">;</span>
  <span class="token keyword">readonly</span> attribute WorkerLocation location<span class="token punctuation">;</span> <span class="token comment">// WorkerLocation对象</span>
  <span class="token keyword">readonly</span> attribute WorkerNavigator navigator<span class="token punctuation">;</span> <span class="token comment">// WorkerNavigator对象</span>
  <span class="token keyword">void</span> <span class="token function">importScripts</span><span class="token punctuation">(</span>USVString<span class="token operator">...</span> urls<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取urls中的每一个URL，按照传入的顺序一个接一个地执行它们并返回</span>

  attribute OnErrorEventHandler onerror<span class="token punctuation">;</span>
  attribute EventHandler onlanguagechange<span class="token punctuation">;</span>
  attribute EventHandler onoffline<span class="token punctuation">;</span>
  attribute EventHandler ononline<span class="token punctuation">;</span>
  attribute EventHandler onrejectionhandled<span class="token punctuation">;</span>
  attribute EventHandler onunhandledrejection<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>WorkerGlobalScope对象有：</p> <ul><li>一个与之关联的type（&quot;classic&quot;或&quot;module&quot;）</li> <li>一个与之关联的HTTPS状态，初始值为&quot;none&quot;</li> <li>一个与之关联的referrer策略，初始值为空字符串</li> <li>一个与之关联的CSP列表，初始值为空列表</li> <li>一个与之关联的模块银蛇，初始为空的模块映射</li></ul> <h3 id="dedicatedworkerglobalscope"><a href="#dedicatedworkerglobalscope" aria-hidden="true" class="header-anchor">#</a> DedicatedWorkerGlobalScope</h3> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token punctuation">[</span>Global<span class="token operator">=</span><span class="token punctuation">(</span>Worker<span class="token punctuation">,</span>DedicatedWorker<span class="token punctuation">)</span><span class="token punctuation">,</span>Exposed<span class="token operator">=</span>DedicatedWorker<span class="token punctuation">]</span>
<span class="token keyword">interface</span> <span class="token class-name">DedicatedWorkerGlobalScope</span> <span class="token punctuation">:</span> WorkerGlobalScope <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token builtin">any</span> message<span class="token punctuation">,</span> optional sequence<span class="token operator">&lt;</span>object<span class="token operator">&gt;</span> transfer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  attribute EventHandler onmessage<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="sharedworkerglobalscope"><a href="#sharedworkerglobalscope" aria-hidden="true" class="header-anchor">#</a> SharedWorkerGlobalScope</h3> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token punctuation">[</span>Global<span class="token operator">=</span><span class="token punctuation">(</span>Worker<span class="token punctuation">,</span>SharedWorker<span class="token punctuation">)</span><span class="token punctuation">,</span>Exposed<span class="token operator">=</span>SharedWorker<span class="token punctuation">]</span>
<span class="token keyword">interface</span> <span class="token class-name">SharedWorkerGlobalScope</span> <span class="token punctuation">:</span> WorkerGlobalScope <span class="token punctuation">{</span>
  <span class="token keyword">readonly</span> attribute DOMString name<span class="token punctuation">;</span> <span class="token comment">// 必须返回SharedWorkerGlobalScope对象的name，使用SharedWorker构造器，可以通过name的值获取该worker的引用</span>

  <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  attribute EventHandler onconnect<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="mutation-observer"><a href="#mutation-observer" aria-hidden="true" class="header-anchor">#</a> Mutation Observer</h2> <p>Mutation Observer API用来监视DOM变动，如节点的增减、属性变动、文本内容的变动。</p> <p>DOM发生变动就会触发Mutation Observer事件。但是，与事件本质不同：</p> <ul><li>事件是同步触发，DOM的变化立即会触发相应的事件</li> <li>Mutation Observer是异步触发，DOM的变化会等到当前所有DOM操作都结束了才会触发</li></ul> <p>解决了DOM变动频繁的问题。如在文档中连续插入1000个</p><p>元素，用Mutation Observer只在1000个元素插入后才触发，且只触发一次</p> <h3 id="使用"><a href="#使用" aria-hidden="true" class="header-anchor">#</a> 使用</h3> <h4 id="构造函数"><a href="#构造函数" aria-hidden="true" class="header-anchor">#</a> 构造函数</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>回调函数接受两个参数，第一个变动数组，第二个观察器实例</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">mutations<span class="token punctuation">,</span> observer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mutations<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">mutation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>mutation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="实例方法"><a href="#实例方法" aria-hidden="true" class="header-anchor">#</a> 实例方法</h4> <h5 id="observe"><a href="#observe" aria-hidden="true" class="header-anchor">#</a> observe()</h5> <blockquote><p>第一个参数：所要观察的DOM节点</p> <p>第二个参数：一个配置对象，指定所要观察的特定变动</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> article <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'article'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
    childList<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    attributes<span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>article<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>options有以下几种</p> <ul><li>childList: 子节点的变动（指新增，删除或更改）</li> <li>attribute: 属性的变动</li> <li>characterData: 节点内容或节点文本的变动</li></ul> <h5 id="disconnect"><a href="#disconnect" aria-hidden="true" class="header-anchor">#</a> disconnect()</h5> <p>用来停止观察。调用方法后，DOM发生变动不会触发观察器</p> <div class="language-js extra-class"><pre class="language-js"><code>observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="takerecords"><a href="#takerecords" aria-hidden="true" class="header-anchor">#</a> takeRecords()</h5> <p>用来清除变动记录。即不在处理未处理的变动。返回变动记录的数组</p> <div class="language-js extra-class"><pre class="language-js"><code>observer<span class="token punctuation">.</span><span class="token function">takeRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="mutationrecord"><a href="#mutationrecord" aria-hidden="true" class="header-anchor">#</a> MutationRecord</h2> <p>Mutation Observer回调函数返回实例的数组，包括以下DOM相关信息</p> <div class="language-js extra-class"><pre class="language-js"><code>type<span class="token punctuation">:</span> <span class="token function">观察的变动类型</span><span class="token punctuation">(</span>attribute、characterData或childList<span class="token punctuation">)</span>
target：发生变动的<span class="token constant">DOM</span>节点
addedNodes：新增的<span class="token constant">DOM</span>节点
removedNodes：删除的<span class="token constant">DOM</span>节点
previousSibling：前一个同级节点，如果没有返回<span class="token keyword">null</span>
nextSibling：下一个同级节点，如果没有则返回<span class="token keyword">null</span>
attributeName：发生变动的属性
oldValue：变动前的值。只对attribute和characterData变动有效，如果发生childList变动，则返回<span class="token keyword">null</span>
</code></pre></div><p>e.g.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">records</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    records<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">record</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Mutation type: '</span> <span class="token operator">+</span> record<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Mutation target: '</span> <span class="token operator">+</span> record<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> option <span class="token operator">=</span> <span class="token punctuation">{</span>
    childList<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    subtree<span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">,</span> option<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用Mutation Observer API时，网页加载DOM节点的生成会产生变动记录，只要观察DOM的变动，就能在第一个时间触发相关事件，因此也就没有必要使用<code>DOMContentLoaded</code>事件</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/knowledge-note/knowledge/Damn-hole-of-http.html" class="prev">
          http/http2/https
        </a></span> <span class="next"><a href="/knowledge-note/knowledge/Damn-hole-of-Browser.html">
          Browser
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/knowledge-note/assets/js/app.5911ee68.js" defer></script><script src="/knowledge-note/assets/js/33.d0be234c.js" defer></script>
  </body>
</html>
